# ShadowTLS + Shadowsocks 分离配置说明

## 当前配置分析

您当前的配置使用：

- **ShadowTLS 端口**: 61672 (TCP)
- **Shadowsocks 内部端口**: 35697 (TCP，通过 ShadowTLS 转发)
- **相同的 Shadowsocks 密码**用于两个服务

## 分离配置方案

### 方案一：`config_separated.json` (推荐)

这个配置提供了完全分离的服务：

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  ShadowTLS      │    │ Shadowsocks     │    │ Shadowsocks     │
│  端口: 61672    │───▶│ 内部: 35697     │    │ UDP直连: 61673  │
│  (TCP伪装)      │    │ (TCP通过STLS)   │    │ (仅UDP)         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

**特点：**

- TCP 流量通过 ShadowTLS 伪装 (端口 61672)
- UDP 流量直接通过 Shadowsocks (端口 61673)
- 两个端口相邻，便于防火墙配置
- **最安全可靠的方案**

### 方案二：`config_optimized.json` (实验性)

这个配置尝试让 UDP 和 TCP 共享相同端口号：

```
┌─────────────────┐    ┌─────────────────┐
│  端口 61672     │    │  端口 61672     │
│  ShadowTLS      │    │  Shadowsocks    │
│  (仅TCP)        │    │  (仅UDP)        │
└─────────────────┘    └─────────────────┘
```

**警告：** 这种配置可能存在端口冲突风险，需要仔细测试。

## 客户端配置

### 对于方案一 (config_separated.json)

**TCP 流量 (通过 ShadowTLS):**

```
服务器: 您的服务器IP
端口: 61672
方法: 2022-blake3-aes-256-gcm
密码: A8TG4X+7jqd05b/tXDowitnAsoW33nI8EB2h3YXJMCc=
ShadowTLS: 启用
ShadowTLS密码: HEgKbb/04e9scG/XZ8bK5iPEb3CWMLnoPTAw35ndJH8=
SNI: p11.douyinpic.com
```

**UDP 流量 (直连 Shadowsocks):**

```
服务器: 您的服务器IP
端口: 61673
方法: 2022-blake3-aes-256-gcm
密码: A8TG4X+7jqd05b/tXDowitnAsoW33nI8EB2h3YXJMCc=
仅UDP: 是
```

### 对于方案二 (config_optimized.json)

如果成功的话，TCP 和 UDP 都可以使用端口 61672。

## 部署建议

1. **测试方案一**（推荐先试这个）
2. 如果方案一工作正常，可以尝试方案二
3. 建议在测试环境先验证配置有效性

## 防火墙配置

**方案一需要开放端口：**

```bash
# ShadowTLS + 内部Shadowsocks
iptables -A INPUT -p tcp --dport 61672 -j ACCEPT
# 直连UDP Shadowsocks
iptables -A INPUT -p udp --dport 61673 -j ACCEPT
```

**方案二需要开放端口：**

```bash
# 同一端口的TCP和UDP
iptables -A INPUT -p tcp --dport 61672 -j ACCEPT
iptables -A INPUT -p udp --dport 61672 -j ACCEPT
```

## 应用配置

将任一配置文件复制到 `/etc/sing-box/config.json`，然后重启服务：

```bash
# 备份原配置
cp /etc/sing-box/config.json /etc/sing-box/config.json.backup

# 应用新配置（选择其中一个）
cp config_separated.json /etc/sing-box/config.json
# 或者
cp config_optimized.json /etc/sing-box/config.json

# 验证配置
sing-box check -c /etc/sing-box/config.json

# 重启服务
systemctl restart sing-box

# 检查状态
systemctl status sing-box
```

## 故障排除

如果遇到端口冲突错误：

1. 检查端口是否被其他程序占用：`netstat -nlp | grep 61672`
2. 确保 sing-box 有权限绑定端口
3. 查看详细日志：`journalctl -u sing-box -f`
