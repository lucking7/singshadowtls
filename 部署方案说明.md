# Sing-Box 三种部署方案说明

## 🎯 新增功能

修改后的 `sb.sh` 脚本现在支持三种部署方案：

### 1. 纯 Shadowsocks（无伪装）

- **性能**: 最佳
- **隐蔽性**: 较低
- **适用**: 网络环境宽松的地区
- **端口**: 单一端口处理 TCP/UDP
- **配置**: 最简单

### 2. ShadowTLS + 分离端口（推荐）

- **性能**: 良好
- **隐蔽性**: 高
- **适用**: 大多数使用场景
- **端口**: TCP 伪装端口 + UDP 独立端口
- **配置**: 推荐配置，兼容性最佳

### 3. ShadowTLS + 共享端口（实验性）

- **性能**: 良好
- **隐蔽性**: 高
- **适用**: 端口受限环境
- **端口**: TCP/UDP 共享同一端口
- **配置**: 实验性功能，需测试

## 📊 部署方案对比

| 特性       | 纯 SS      | STLS+分离  | STLS+共享  |
| ---------- | ---------- | ---------- | ---------- |
| 性能       | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐   | ⭐⭐⭐⭐   |
| 隐蔽性     | ⭐⭐       | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 稳定性     | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐     |
| 端口数量   | 1 个       | 2 个       | 1 个       |
| 配置复杂度 | 简单       | 中等       | 中等       |

## 🔧 脚本输出格式

### 纯 Shadowsocks 输出

```
CN [ss2022][纯SS] = ss, IP, PORT, encrypt-method=2022-blake3-aes-256-gcm, password=PASSWORD, udp-relay=true
```

### ShadowTLS + 分离端口输出

```
CN [ss2022][shadow-tls-v3][分离端口] = ss, IP, PORT1, encrypt-method=2022-blake3-aes-256-gcm, password=PASSWORD, shadow-tls-password=STLS_PASSWORD, shadow-tls-sni=SNI, shadow-tls-version=3, udp-relay=true, udp-port=PORT2
```

**可选配置:**

- 仅 TCP: 不包含 udp-relay 参数
- 仅 UDP: 直连 UDP 端口

### ShadowTLS + 共享端口输出

```
CN [ss2022][shadow-tls-v3][共享端口] = ss, IP, PORT, encrypt-method=2022-blake3-aes-256-gcm, password=PASSWORD, shadow-tls-password=STLS_PASSWORD, shadow-tls-sni=SNI, shadow-tls-version=3, udp-relay=true
```

## 🚀 使用说明

### 安装

```bash
# 运行脚本
./sb.sh

# 选择安装
选项 1: Install/Update Sing-Box

# 选择部署方案
1) 纯Shadowsocks        # 无伪装，性能最佳
2) ShadowTLS + 分离端口  # 推荐方案
3) ShadowTLS + 共享端口  # 实验性方案
```

### 端口配置

- **纯 SS**: 一个公开端口
- **STLS+分离**: ShadowTLS 端口 + UDP 端口（相邻端口）
- **STLS+共享**: 一个共享端口（实验性）

### 防火墙配置

**纯 Shadowsocks:**

```bash
iptables -A INPUT -p tcp --dport PORT -j ACCEPT
iptables -A INPUT -p udp --dport PORT -j ACCEPT
```

**ShadowTLS + 分离端口:**

```bash
iptables -A INPUT -p tcp --dport PORT1 -j ACCEPT  # ShadowTLS
iptables -A INPUT -p udp --dport PORT2 -j ACCEPT  # UDP
```

**ShadowTLS + 共享端口:**

```bash
iptables -A INPUT -p tcp --dport PORT -j ACCEPT
iptables -A INPUT -p udp --dport PORT -j ACCEPT
```

## ⚙️ 技术实现

### 配置结构对比

**纯 Shadowsocks:**

```json
{
  "inbounds": [
    {
      "type": "shadowsocks",
      "listen": "::",
      "listen_port": PORT,
      "method": "2022-blake3-aes-256-gcm",
      "password": "PASSWORD"
    }
  ]
}
```

**ShadowTLS + 分离端口:**

```json
{
  "inbounds": [
    {
      "type": "shadowtls",
      "listen": "::",
      "listen_port": PORT1,
      "detour": "shadowsocks-in"
    },
    {
      "type": "shadowsocks",
      "tag": "shadowsocks-in",
      "listen": "127.0.0.1",
      "listen_port": INTERNAL_PORT,
      "network": "tcp"
    },
    {
      "type": "shadowsocks",
      "listen": "::",
      "listen_port": PORT2,
      "network": "udp"
    }
  ]
}
```

**ShadowTLS + 共享端口:**

```json
{
  "inbounds": [
    {
      "type": "shadowtls",
      "listen": "::",
      "listen_port": PORT,
      "detour": "shadowsocks-in"
    },
    {
      "type": "shadowsocks",
      "tag": "shadowsocks-in",
      "listen": "127.0.0.1",
      "listen_port": INTERNAL_PORT,
      "network": "tcp"
    },
    {
      "type": "shadowsocks",
      "listen": "::",
      "listen_port": PORT,  # 与ShadowTLS共享端口
      "network": "udp"
    }
  ]
}
```

## 🎛️ 管理功能

脚本支持的管理功能：

- ✅ 端口修改（支持所有方案）
- ✅ 密码修改（SS 和 ShadowTLS 分别管理）
- ✅ SNI 修改（ShadowTLS 方案）
- ✅ 配置查看（自动识别部署方案）
- ✅ 服务状态监控
- ✅ 日志查看

## 📋 兼容性说明

### 客户端支持

- **Surge**: 完全支持所有方案
- **Clash**: 需要支持 ShadowTLS 的版本
- **sing-box 客户端**: 完全支持
- **其他 SS 客户端**: 仅支持纯 SS 方案

### 推荐配置

1. **首选**: ShadowTLS + 分离端口（兼容性最佳）
2. **次选**: ShadowTLS + 共享端口（节省端口）
3. **备选**: 纯 Shadowsocks（极简环境）

## 🔍 故障排除

### 端口冲突

- 检查端口占用: `netstat -nlp | grep PORT`
- 更换端口: 使用脚本的端口修改功能

### 共享端口问题

- ShadowTLS 和 UDP 可能出现冲突
- 建议优先使用分离端口方案

### 性能优化

- 纯 SS 方案性能最佳
- ShadowTLS 方案在高负载时可能略有性能损失
