# 脚本优化说明

## 优化目标

根据 DNS 解锁三层架构方案,优化 `sb.sh` 和 `install_sniproxy.sh` 两个脚本,删除不必要的配置,保留核心功能。

---

## 三层架构回顾

```
客户端设备
    ↓ (Shadowsocks + ShadowTLS)
被解锁机 (中转代理服务器)
    ├── sing-box (inbound)
    ├── DNS 分流配置 (选项 14)
    └── 出站路由规则
    ↓
解锁机
    ├── SNI Proxy (0.0.0.0:80/443)
    └── sing-box DNS 服务器 (0.0.0.0:53) - 选项 15
```

---

## sb.sh 优化方案

### 选项 13: 流媒体解锁设置 (简化)

**当前问题:**
- 提供了 FakeIP 模式和标准 DNS 模式
- FakeIP 模式对于三层架构不是必需的
- 配置过于复杂

**优化方案:**
- ❌ 删除 FakeIP 模式 (选项 1)
- ❌ 删除标准 DNS 模式 (选项 2)
- ✅ 保留查看当前配置 (选项 3)
- ✅ 添加说明: 此选项用于单机优化,三层架构请使用选项 14 和 15

**修改后的选项 13:**
```
流媒体解锁设置 (单机优化)
  1) 查看当前配置
  2) 清除流媒体解锁配置
  0) 返回主菜单

说明: 
- 此选项用于单机流媒体解锁优化
- 三层架构解锁方案请使用:
  * 被解锁机: 选项 14 (DNS 分流配置)
  * 解锁机: 选项 15 (DNS 解锁服务器)
```

---

### 选项 14: DNS 分流配置 (保留并优化)

**当前功能:**
- 配置不同流媒体平台使用不同 DNS 服务器
- 支持自定义解锁 DNS 服务器
- 支持 IPv6 优先策略

**优化方案:**
- ✅ 完全保留此功能
- ✅ 这是被解锁机的核心配置
- ✅ 添加更清晰的说明

**保持不变,只优化说明:**
```
DNS 分流配置 (被解锁机使用)

此功能用于配置被解锁机的 DNS 分流规则:
- 流媒体/AI 域名 → 解锁机 DNS (解锁机IP:53)
- 其他域名 → Cloudflare/Google DNS

适用场景: 被解锁机作为中转代理服务器
```

---

### 选项 15: 纯 DNS 解锁服务器 (保留并优化)

**当前功能:**
- 部署纯 DNS 解锁服务器
- 监听 0.0.0.0:53
- 使用 Predefined DNS 或 FakeIP

**优化方案:**
- ✅ 保留部署功能
- ✅ 保留 Predefined DNS 模式
- ❌ 简化 FakeIP 模式 (可选)
- ✅ 添加更清晰的说明

**优化后的选项 15:**
```
DNS 解锁服务器部署 (解锁机使用)

此功能用于在解锁机上部署 DNS 服务器:
- 监听 0.0.0.0:53
- 将流媒体域名解析到解锁机 IP
- 配合 SNI Proxy 实现解锁

适用场景: 解锁机部署 DNS 服务器
前置要求: 已部署 SNI Proxy (使用 install_sniproxy.sh)
```

---

## install_sniproxy.sh 优化方案

### 当前功能

- 自动安装 SNI Proxy
- 从 MetaCubeX 规则库提取域名
- 生成 /etc/sniproxy.conf
- 监听 0.0.0.0:80 和 0.0.0.0:443

### 优化方案

**✅ 保持所有功能不变**

**原因:**
- SNI Proxy 是解锁的核心组件
- 当前配置已经正确 (监听 0.0.0.0)
- 域名提取功能很有用
- 不需要修改

**可选优化:**
- 添加更清晰的使用说明
- 添加与 sb.sh 选项 15 的配合说明

---

## 主菜单优化

### 当前主菜单 (选项 13-15)

```
13) 流媒体解锁设置 (类似 SNI Proxy + smartdns)
14) DNS 分流配置 (按平台配置不同 DNS)
15) 纯 DNS 解锁服务器 (不代理流量)
```

### 优化后的主菜单

```
13) 流媒体解锁设置 (单机优化 - 查看/清除配置)
14) DNS 分流配置 (被解锁机 - 配置解锁 DNS)
15) DNS 解锁服务器 (解锁机 - 部署 DNS 服务)
```

---

## 具体修改清单

### sb.sh 修改

#### 1. 修改 `configure_streaming_unlock()` 函数 (行 2227-2394)

**删除:**
- 选项 1: 启用 FakeIP 模式 (行 2252-2293)
- 选项 2: 标准 DNS 模式 (行 2295-2331)

**保留:**
- 选项 3: 查看当前配置 (行 2333-2358)

**添加:**
- 选项 2: 清除流媒体解锁配置
- 更清晰的说明文字

#### 2. 修改主菜单 `show_menu()` 函数 (行 4327-4366)

**修改行 4353-4355:**
```bash
# 修改前:
echo -e "  ${CYAN}13)${NC} 流媒体解锁设置 ${YELLOW}(类似 SNI Proxy + smartdns)${NC}"
echo -e "  ${CYAN}14)${NC} DNS 分流配置 ${YELLOW}(按平台配置不同 DNS)${NC}"
echo -e "  ${CYAN}15)${NC} 纯 DNS 解锁服务器 ${YELLOW}(不代理流量)${NC}\n"

# 修改后:
echo -e "  ${CYAN}13)${NC} 流媒体解锁设置 ${YELLOW}(单机优化 - 查看/清除)${NC}"
echo -e "  ${CYAN}14)${NC} DNS 分流配置 ${YELLOW}(被解锁机 - 配置解锁 DNS)${NC}"
echo -e "  ${CYAN}15)${NC} DNS 解锁服务器 ${YELLOW}(解锁机 - 部署 DNS 服务)${NC}\n"
```

#### 3. 优化 `configure_dns_routing()` 函数 (行 2397-2430)

**添加说明:**
```bash
echo -e "${CYAN}此功能用于被解锁机配置 DNS 分流规则${NC}"
echo -e "${CYAN}流媒体/AI 域名使用解锁机 DNS,其他域名使用公共 DNS${NC}\n"
```

#### 4. 优化 `configure_dns_unlock_server()` 函数 (行 2950-2989)

**添加说明:**
```bash
echo -e "${CYAN}此功能用于在解锁机上部署 DNS 服务器${NC}"
echo -e "${CYAN}配合 SNI Proxy 实现流媒体解锁${NC}"
echo -e "${YELLOW}前置要求: 已使用 install_sniproxy.sh 部署 SNI Proxy${NC}\n"
```

---

### install_sniproxy.sh 修改

**✅ 不需要修改**

**原因:**
- 当前配置已经正确
- 监听 0.0.0.0:80/443
- 域名提取功能完善
- 符合三层架构需求

**可选优化 (不强制):**
- 在帮助信息中添加与 sb.sh 的配合说明

---

## 优化后的使用流程

### 解锁机配置流程

```bash
# 1. 部署 SNI Proxy
bash install_sniproxy.sh -y -s "Netflix,Disney+,OpenAI"

# 2. 部署 DNS 服务器
./sb.sh
# 选择: 15) DNS 解锁服务器
# 选择: 1) 部署纯 DNS 解锁服务器
# 监听地址: 0.0.0.0
# 监听端口: 53
```

### 被解锁机配置流程

```bash
# 1. 配置 DNS 分流
./sb.sh
# 选择: 14) DNS 分流配置
# 选择: 1) 配置 DNS 分流规则
# 所有流媒体选择: 6) 自定义解锁 DNS 服务器
# DNS 服务器地址: 解锁机IP
# DNS 协议类型: 1) UDP
```

---

## 删除的功能说明

### 选项 13 删除的功能

**删除: FakeIP 模式**
- 原因: 三层架构不需要在被解锁机或解锁机上使用 FakeIP
- 替代: 解锁机使用 Predefined DNS,被解锁机使用 DNS 分流

**删除: 标准 DNS 模式**
- 原因: 功能与选项 14 重复
- 替代: 使用选项 14 配置 DNS 分流

### 保留的功能

**保留: 查看当前配置**
- 原因: 用于调试和验证
- 用途: 查看流媒体解锁相关的 DNS 配置

**新增: 清除流媒体解锁配置**
- 原因: 方便清理不需要的配置
- 用途: 恢复默认 DNS 设置

---

## 总结

### 修改范围

| 文件 | 修改内容 | 影响范围 |
|------|----------|----------|
| sb.sh | 简化选项 13 | 删除 FakeIP 和标准 DNS 模式 |
| sb.sh | 优化选项 14 说明 | 添加被解锁机使用说明 |
| sb.sh | 优化选项 15 说明 | 添加解锁机使用说明 |
| sb.sh | 修改主菜单 | 更新选项 13-15 的描述 |
| install_sniproxy.sh | 不修改 | 保持原样 |

### 优化效果

- ✅ 简化了选项 13,避免混淆
- ✅ 明确了选项 14 用于被解锁机
- ✅ 明确了选项 15 用于解锁机
- ✅ 删除了不必要的 FakeIP 配置
- ✅ 保留了所有核心功能
- ✅ 符合三层架构需求

---

## 下一步

1. 修改 sb.sh 的 `configure_streaming_unlock()` 函数
2. 修改 sb.sh 的主菜单描述
3. 优化 sb.sh 的选项 14 和 15 说明
4. 测试修改后的功能
5. 验证三层架构配置流程

