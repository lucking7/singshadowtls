# 三层架构快速配置指南

## 架构概述

```
客户端设备
    ↓ (Shadowsocks + ShadowTLS)
被解锁机 (中转代理服务器)
    ├── sing-box (inbound)
    ├── DNS 分流配置 (sb.sh 选项 14)
    └── 出站路由规则
    ↓
解锁机
    ├── SNI Proxy (install_sniproxy.sh)
    └── sing-box DNS 服务器 (sb.sh 选项 15)
```

---

## 快速配置步骤

### 步骤 1: 在解锁机上部署 SNI Proxy

```bash
# 下载脚本
wget https://raw.githubusercontent.com/lucking7/singshadowtls/main/install_sniproxy.sh

# 运行脚本
bash install_sniproxy.sh -y -s "Netflix,Disney+,OpenAI"
```

**验证:**
```bash
# 检查 SNI Proxy 状态
systemctl status sniproxy

# 检查监听端口
netstat -tlnp | grep sniproxy
# 应该看到: 0.0.0.0:80 和 0.0.0.0:443
```

---

### 步骤 2: 在解锁机上部署 DNS 服务器

```bash
# 运行 sb.sh
./sb.sh

# 选择: 15) DNS 解锁服务器
# 选择: 1) 部署 DNS 解锁服务器
```

**配置参数:**
- 监听地址: `0.0.0.0` (默认)
- 监听端口: `53` (默认)
- 是否使用其他服务器的解锁 DNS: `N` (不使用,自己就是解锁机)

**验证:**
```bash
# 检查 DNS 服务器状态
systemctl status sing-box

# 检查监听端口
netstat -ulnp | grep 53
# 应该看到: 0.0.0.0:53

# 测试 DNS 解析
dig @127.0.0.1 netflix.com
# 应该返回: 解锁机IP
```

---

### 步骤 3: 在被解锁机上配置 DNS 分流

```bash
# 运行 sb.sh
./sb.sh

# 选择: 14) DNS 分流配置
# 选择: 1) 配置 DNS 分流规则
```

**配置流程:**

1. **Netflix 使用哪个 DNS 服务器?**
   - 选择: `6) 自定义解锁 DNS 服务器`

2. **配置自定义解锁 DNS 服务器:**
   - DNS 服务器地址: `解锁机IP` (例如: 1.2.3.4)
   - DNS 协议类型: `1) UDP`
   - DNS 端口: `53` (默认)
   - DNS 服务器标签名称: `dns_unlock` (默认)

3. **Disney+ 使用哪个 DNS 服务器?**
   - 选择: `6) 自定义解锁 DNS 服务器` (会复用之前配置的 dns_unlock)

4. **Spotify 使用哪个 DNS 服务器?**
   - 选择: `6) 自定义解锁 DNS 服务器`

5. **YouTube 使用哪个 DNS 服务器?**
   - 选择: `6) 自定义解锁 DNS 服务器`

6. **其他流媒体使用哪个 DNS 服务器?**
   - 选择: `6) 自定义解锁 DNS 服务器`

7. **选择解析策略:**
   - Netflix 解析策略: `2) ipv6_only` (推荐)
   - Disney+ 解析策略: `2) ipv6_only` (推荐)
   - 其他流媒体解析策略: `4) prefer_ipv6` (推荐)

**验证:**
```bash
# 检查 DNS 配置
jq '.dns.servers[] | select(.tag == "dns_unlock")' /etc/sing-box/config.json

# 测试 DNS 查询
dig @127.0.0.1 netflix.com
# 应该返回: 解锁机IP

dig @127.0.0.1 google.com
# 应该返回: Google 的真实 IP
```

---

### 步骤 4: 在被解锁机上配置出站路由 (可选)

如果被解锁机和解锁机之间需要代理,配置出站路由:

```bash
vim /etc/sing-box/config.json
```

**添加路由规则:**
```json
{
  "route": {
    "rules": [
      {
        "rule_set": ["geosite-netflix", "geosite-disney", "geosite-openai"],
        "outbound": "direct"
      }
    ]
  }
}
```

**重启服务:**
```bash
systemctl restart sing-box
```

---

## 完整配置示例

### 解锁机配置

#### SNI Proxy 配置 (/etc/sniproxy.conf)

```conf
user daemon
pidfile /var/tmp/sniproxy.pid

resolver {
    nameserver 8.8.8.8
    nameserver 1.1.1.1
    mode ipv4_only
}

listener 0.0.0.0:80 {
    proto http
}

listener 0.0.0.0:443 {
    proto tls
}

table {
    .*netflix\.com$ *
    .*nflximg\.com$ *
    .*openai\.com$ *
    .*chatgpt\.com$ *
}
```

---

#### sing-box DNS 配置 (/etc/sing-box/config.json)

```json
{
  "dns": {
    "servers": [
      {
        "tag": "dns_predefined",
        "address": "predefined",
        "predefined": {
          "netflix.com": ["解锁机IP"],
          "nflximg.com": ["解锁机IP"],
          "openai.com": ["解锁机IP"],
          "chatgpt.com": ["解锁机IP"]
        }
      },
      {
        "tag": "dns_cloudflare",
        "address": "https://1.1.1.1/dns-query"
      }
    ],
    "rules": [
      {
        "rule_set": ["geosite-netflix", "geosite-disney", "geosite-openai"],
        "server": "dns_predefined"
      }
    ],
    "final": "dns_cloudflare"
  },
  "inbounds": [
    {
      "type": "direct",
      "tag": "dns-in",
      "listen": "0.0.0.0",
      "listen_port": 53,
      "network": "udp"
    }
  ],
  "outbounds": [
    {
      "type": "direct",
      "tag": "direct"
    }
  ]
}
```

---

### 被解锁机配置

#### sing-box DNS 分流配置 (/etc/sing-box/config.json)

```json
{
  "dns": {
    "servers": [
      {
        "tag": "dns_cloudflare",
        "type": "https",
        "server": "1.1.1.1",
        "server_port": 443
      },
      {
        "tag": "dns_unlock",
        "type": "udp",
        "server": "解锁机IP",
        "server_port": 53
      }
    ],
    "rules": [
      {
        "rule_set": ["geosite-netflix"],
        "server": "dns_unlock",
        "strategy": "ipv6_only"
      },
      {
        "rule_set": ["geosite-disney"],
        "server": "dns_unlock",
        "strategy": "ipv6_only"
      },
      {
        "rule_set": ["geosite-openai"],
        "server": "dns_unlock",
        "strategy": "prefer_ipv6"
      }
    ],
    "final": "dns_cloudflare"
  },
  "route": {
    "rules": [
      {
        "rule_set": ["geosite-netflix", "geosite-disney", "geosite-openai"],
        "outbound": "direct"
      }
    ]
  }
}
```

---

## 常见问题

### Q1: 解锁机必须部署 DNS 服务器吗?

**A:** 是的!只部署 SNI Proxy 无法工作。

**原因:**
- SNI Proxy 只能处理发送到它的流量
- 如果 DNS 返回流媒体的真实 IP,流量不会发送到 SNI Proxy
- 必须部署 DNS 服务器,将流媒体域名解析到解锁机 IP

---

### Q2: 被解锁机需要查询解锁机的 DNS 吗?

**A:** 是的!这是关键配置。

**配置方法:**
- 使用 `sb.sh` 选项 14 配置 DNS 分流
- 流媒体域名的 DNS 查询会发送到解锁机的 DNS 服务器
- 解锁机返回解锁 IP (解锁机自己的 IP)

---

### Q3: 如何验证配置是否正确?

**A:** 按照以下步骤验证:

**在解锁机上:**
```bash
# 1. 检查 SNI Proxy
netstat -tlnp | grep sniproxy

# 2. 检查 DNS 服务器
netstat -ulnp | grep 53

# 3. 测试 DNS 解析
dig @127.0.0.1 netflix.com
```

**在被解锁机上:**
```bash
# 1. 检查 DNS 配置
jq '.dns.servers[] | select(.tag == "dns_unlock")' /etc/sing-box/config.json

# 2. 测试 DNS 查询
dig @127.0.0.1 netflix.com

# 3. 查看日志
journalctl -u sing-box -f
```

---

### Q4: 选项 13 还能用吗?

**A:** 可以,但不推荐用于三层架构。

**选项 13 的新功能:**
- 查看当前流媒体解锁配置
- 清除流媒体解锁配置

**三层架构请使用:**
- 被解锁机: 选项 14 (DNS 分流配置)
- 解锁机: 选项 15 (DNS 解锁服务器)

---

### Q5: 如何清除旧的 FakeIP 配置?

**A:** 使用选项 13 的清除功能:

```bash
./sb.sh
# 选择: 13) 流媒体解锁设置
# 选择: 2) 清除流媒体解锁配置
# 确认: y
```

---

## 故障排查

### 问题 1: DNS 查询返回真实 IP,不是解锁机 IP

**可能原因:**
- 解锁机 DNS 服务器未正确配置
- 被解锁机未使用解锁机 DNS

**解决方法:**
```bash
# 在解锁机上检查 DNS 配置
jq '.dns.servers[] | select(.tag == "dns_predefined")' /etc/sing-box/config.json

# 在被解锁机上检查 DNS 配置
jq '.dns.servers[] | select(.tag == "dns_unlock")' /etc/sing-box/config.json
```

---

### 问题 2: 流媒体无法访问

**可能原因:**
- SNI Proxy 未运行
- DNS 解析不正确
- 路由规则配置错误

**解决方法:**
```bash
# 检查 SNI Proxy 状态
systemctl status sniproxy

# 检查 DNS 解析
dig @127.0.0.1 netflix.com

# 查看 SNI Proxy 日志
journalctl -u sniproxy -f

# 查看 sing-box 日志
journalctl -u sing-box -f
```

---

### 问题 3: 端口 53 被占用

**可能原因:**
- systemd-resolved 正在运行
- dnsmasq 正在运行
- 其他 DNS 服务器正在运行

**解决方法:**
```bash
# 停止 systemd-resolved
systemctl stop systemd-resolved
systemctl disable systemd-resolved

# 或停止 dnsmasq
systemctl stop dnsmasq
systemctl disable dnsmasq

# 修改 /etc/resolv.conf
rm /etc/resolv.conf
echo "nameserver 1.1.1.1" > /etc/resolv.conf
```

---

## 总结

### 配置步骤

1. **解锁机:**
   - 部署 SNI Proxy (install_sniproxy.sh)
   - 部署 DNS 服务器 (sb.sh 选项 15)

2. **被解锁机:**
   - 配置 DNS 分流 (sb.sh 选项 14)
   - 配置出站路由 (可选)

3. **客户端:**
   - 连接到被解锁机的 Shadowsocks + ShadowTLS 服务

### 关键要点

- ✅ 解锁机必须同时部署 SNI Proxy 和 DNS 服务器
- ✅ 被解锁机必须查询解锁机的 DNS 服务器
- ✅ DNS 分流: 流媒体 → 解锁机 DNS,其他 → Cloudflare DNS
- ✅ 所有流量通过被解锁机中转

### sb.sh 菜单选项

| 服务器 | 使用选项 | 说明 |
|--------|----------|------|
| 解锁机 | **选项 15** | 部署 DNS 服务器 (0.0.0.0:53) |
| 被解锁机 | **选项 14** | 配置 DNS 分流 (使用解锁机 DNS) |

---

**配置完成后,客户端就可以通过被解锁机访问流媒体了!** 🎉

