# 脚本修改总结

## 修改概述

根据 DNS 解锁三层架构方案,对 `sb.sh` 脚本进行了优化,删除了不必要的配置,保留了核心功能。

---

## 修改内容

### 1. sb.sh - 选项 13: 流媒体解锁设置

**修改位置:** 行 2226-2340

**修改前:**
- 提供 FakeIP 模式 (选项 1)
- 提供标准 DNS 模式 (选项 2)
- 查看当前配置 (选项 3)

**修改后:**
- ❌ 删除 FakeIP 模式
- ❌ 删除标准 DNS 模式
- ✅ 保留查看当前配置 (选项 1)
- ✅ 新增清除流媒体解锁配置 (选项 2)
- ✅ 添加三层架构使用说明

**新功能说明:**
```
流媒体解锁配置 (单机优化)

此功能用于单机流媒体解锁优化
注意: 三层架构解锁方案请使用:
  • 被解锁机: 选项 14 (DNS 分流配置)
  • 解锁机: 选项 15 (DNS 解锁服务器)

选择操作:
  1) 查看当前流媒体解锁配置
  2) 清除流媒体解锁配置
  0) 返回主菜单
```

**清除配置功能:**
- 删除 FakeIP DNS 服务器
- 删除流媒体 DNS 规则
- 禁用 FakeIP 缓存
- 自动备份当前配置

---

### 2. sb.sh - 选项 14: DNS 分流配置

**修改位置:** 行 2342-2360

**修改前:**
```
DNS 分流配置 (按平台配置不同 DNS)

此功能允许为不同的流媒体平台配置不同的 DNS 服务器
例如: Netflix 使用 Cloudflare, Disney+ 使用 Google DNS
```

**修改后:**
```
DNS 分流配置 (被解锁机)

此功能用于被解锁机配置 DNS 分流规则
流媒体/AI 域名使用解锁机 DNS,其他域名使用公共 DNS

适用场景:
  • 被解锁机作为中转代理服务器
  • 需要将流媒体流量转发到解锁机
  • 解锁机已部署 SNI Proxy + DNS 服务器
```

**功能保持不变:**
- ✅ 配置 DNS 分流规则
- ✅ 查看当前 DNS 分流配置
- ✅ 恢复默认 DNS 配置
- ✅ 支持自定义解锁 DNS 服务器

---

### 3. sb.sh - 选项 15: DNS 解锁服务器

**修改位置:** 行 2901-2924

**修改前:**
```
纯 DNS 解锁服务器配置 (不代理流量)

此功能将 sing-box 配置为纯 DNS 解锁服务器
只提供 DNS 解析服务，不代理流量
客户端设置 DNS 为本服务器 IP 即可使用
```

**修改后:**
```
DNS 解锁服务器部署 (解锁机)

此功能用于在解锁机上部署 DNS 服务器
配合 SNI Proxy 实现流媒体解锁

适用场景:
  • 解锁机部署 DNS 服务器
  • 将流媒体域名解析到解锁机 IP
  • 配合 SNI Proxy 实现解锁

前置要求:
  • 已使用 install_sniproxy.sh 部署 SNI Proxy
  • SNI Proxy 监听 0.0.0.0:80/443
```

**功能保持不变:**
- ✅ 部署 DNS 解锁服务器
- ✅ 查看 DNS 服务器配置
- ✅ 测试 DNS 服务器
- ✅ 生成客户端配置说明

---

### 4. sb.sh - 主菜单

**修改位置:** 行 4291-4301

**修改前:**
```
13) 流媒体解锁设置 (类似 SNI Proxy + smartdns)
14) DNS 分流配置 (按平台配置不同 DNS)
15) 纯 DNS 解锁服务器 (不代理流量)
```

**修改后:**
```
13) 流媒体解锁设置 (单机优化 - 查看/清除)
14) DNS 分流配置 (被解锁机 - 配置解锁 DNS)
15) DNS 解锁服务器 (解锁机 - 部署 DNS 服务)
```

---

### 5. install_sniproxy.sh

**修改:** ✅ 无需修改

**原因:**
- 当前配置已经正确
- 监听 0.0.0.0:80/443
- 域名提取功能完善
- 符合三层架构需求

---

## 删除的功能

### 选项 13 删除的功能

#### 1. FakeIP 模式 (已删除)

**原功能:**
- 添加 FakeIP DNS 服务器
- 配置流媒体使用 FakeIP
- 启用 FakeIP 缓存

**删除原因:**
- 三层架构不需要 FakeIP
- 解锁机使用 Predefined DNS
- 被解锁机使用 DNS 分流

**替代方案:**
- 解锁机: 使用选项 15 部署 DNS 服务器 (Predefined DNS)
- 被解锁机: 使用选项 14 配置 DNS 分流

---

#### 2. 标准 DNS 模式 (已删除)

**原功能:**
- 配置流媒体使用 IPv6 优先策略
- 使用 Cloudflare DNS

**删除原因:**
- 功能与选项 14 重复
- 不符合三层架构需求

**替代方案:**
- 使用选项 14 配置 DNS 分流
- 支持自定义解锁 DNS 服务器

---

## 新增的功能

### 选项 13 新增功能

#### 清除流媒体解锁配置

**功能描述:**
- 删除 FakeIP DNS 服务器
- 删除流媒体 DNS 规则
- 禁用 FakeIP 缓存
- 自动备份当前配置

**使用场景:**
- 清理不需要的流媒体解锁配置
- 恢复默认 DNS 设置
- 切换到三层架构方案

**操作流程:**
```bash
./sb.sh
# 选择: 13) 流媒体解锁设置
# 选择: 2) 清除流媒体解锁配置
# 确认: y
```

---

## 保留的功能

### 选项 13 保留功能

#### 查看当前流媒体解锁配置

**功能描述:**
- 检查 FakeIP 配置状态
- 查看流媒体 DNS 规则
- 查看 FakeIP 缓存状态

**使用场景:**
- 调试和验证配置
- 检查是否有残留配置
- 了解当前解锁状态

---

### 选项 14 保留功能

#### 配置 DNS 分流规则

**功能描述:**
- 为不同流媒体平台配置不同 DNS 服务器
- 支持自定义解锁 DNS 服务器
- 支持 IPv6 优先策略

**核心配置:**
- Netflix → 解锁机 DNS
- Disney+ → 解锁机 DNS
- OpenAI → 解锁机 DNS
- 其他域名 → Cloudflare DNS

---

### 选项 15 保留功能

#### 部署 DNS 解锁服务器

**功能描述:**
- 部署 sing-box DNS 服务器
- 监听 0.0.0.0:53
- 使用 Predefined DNS 或 FakeIP
- 将流媒体域名解析到解锁机 IP

**核心配置:**
- 监听地址: 0.0.0.0
- 监听端口: 53
- DNS 类型: Predefined DNS
- 流媒体域名 → 解锁机 IP

---

## 使用流程

### 解锁机配置流程

```bash
# 1. 部署 SNI Proxy
bash install_sniproxy.sh -y -s "Netflix,Disney+,OpenAI"

# 2. 部署 DNS 服务器
./sb.sh
# 选择: 15) DNS 解锁服务器
# 选择: 1) 部署 DNS 解锁服务器
# 监听地址: 0.0.0.0
# 监听端口: 53
```

---

### 被解锁机配置流程

```bash
# 1. 配置 DNS 分流
./sb.sh
# 选择: 14) DNS 分流配置
# 选择: 1) 配置 DNS 分流规则

# 2. 配置流媒体 DNS
# Netflix: 6) 自定义解锁 DNS 服务器
#   - DNS 服务器地址: 解锁机IP
#   - DNS 协议类型: 1) UDP
#   - DNS 端口: 53

# Disney+: 6) 自定义解锁 DNS 服务器 (复用)
# OpenAI: 6) 自定义解锁 DNS 服务器 (复用)
# 其他流媒体: 6) 自定义解锁 DNS 服务器 (复用)
```

---

### 清除旧配置流程 (如果需要)

```bash
# 如果之前使用了选项 13 的 FakeIP 模式
./sb.sh
# 选择: 13) 流媒体解锁设置
# 选择: 2) 清除流媒体解锁配置
# 确认: y
```

---

## 验证配置

### 解锁机验证

```bash
# 1. 检查 SNI Proxy
netstat -tlnp | grep sniproxy
# 应该看到: 0.0.0.0:80 和 0.0.0.0:443

# 2. 检查 DNS 服务器
netstat -ulnp | grep 53
# 应该看到: 0.0.0.0:53

# 3. 测试 DNS 解析
dig @127.0.0.1 netflix.com
# 应该返回: 解锁机IP
```

---

### 被解锁机验证

```bash
# 1. 检查 DNS 配置
jq '.dns.servers[] | select(.tag == "dns_unlock")' /etc/sing-box/config.json
# 应该看到自定义解锁 DNS 配置

# 2. 测试 DNS 查询
dig @127.0.0.1 netflix.com
# 应该返回: 解锁机IP

# 3. 查看 sing-box 日志
journalctl -u sing-box -f
# 应该看到 DNS 查询和流量转发日志
```

---

## 修改影响

### 对现有用户的影响

**如果之前使用了选项 13 的 FakeIP 模式:**
- ✅ 配置仍然有效,不会自动删除
- ✅ 可以继续使用
- ✅ 可以使用新增的"清除配置"功能清理

**如果之前使用了选项 14:**
- ✅ 功能完全保留,不受影响
- ✅ 只是说明文字更清晰

**如果之前使用了选项 15:**
- ✅ 功能完全保留,不受影响
- ✅ 只是说明文字更清晰

---

### 对新用户的影响

**优势:**
- ✅ 更清晰的选项说明
- ✅ 明确的使用场景
- ✅ 符合三层架构需求
- ✅ 避免配置混淆

**注意事项:**
- ⚠️ 选项 13 不再提供 FakeIP 配置
- ⚠️ 需要使用选项 14 和 15 配置三层架构
- ⚠️ 解锁机必须先部署 SNI Proxy

---

## 总结

### 修改范围

| 文件 | 修改行数 | 修改内容 |
|------|----------|----------|
| sb.sh | 2226-2340 | 简化选项 13 |
| sb.sh | 2342-2360 | 优化选项 14 说明 |
| sb.sh | 2901-2924 | 优化选项 15 说明 |
| sb.sh | 4291-4301 | 修改主菜单描述 |
| install_sniproxy.sh | - | 无需修改 |

---

### 优化效果

- ✅ 简化了选项 13,避免混淆
- ✅ 明确了选项 14 用于被解锁机
- ✅ 明确了选项 15 用于解锁机
- ✅ 删除了不必要的 FakeIP 配置
- ✅ 保留了所有核心功能
- ✅ 符合三层架构需求
- ✅ 添加了清除配置功能
- ✅ 改进了用户体验

---

### 兼容性

- ✅ 向后兼容 (旧配置仍然有效)
- ✅ 不影响现有用户
- ✅ 新用户体验更好
- ✅ 符合最佳实践

---

## 下一步建议

1. ✅ 测试修改后的功能
2. ✅ 验证三层架构配置流程
3. ✅ 更新文档和教程
4. ✅ 收集用户反馈
5. ✅ 持续优化改进

