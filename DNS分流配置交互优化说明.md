# DNS 分流配置交互优化说明

## 问题描述

### 原有交互流程的问题

**场景：**
用户想为所有流媒体平台（Netflix、Disney+、Spotify、YouTube、其他流媒体）配置相同的自定义 DNS 服务器（如 155.117.18.254）。

**原有流程：**
1. Netflix 选择"6) 自定义解锁 DNS 服务器"
2. 输入 DNS 配置（地址、协议、端口、标签）
3. Disney+ 再次选择"6) 自定义解锁 DNS 服务器"
4. 重复输入相同的 DNS 配置
5. Spotify、YouTube、其他流媒体重复步骤 3-4

**问题：**
- ❌ 需要重复选择 5 次"6) 自定义解锁 DNS 服务器"
- ❌ 需要重复输入 5 次相同的配置信息
- ❌ 效率低下，容易出错
- ❌ 用户体验差

---

## 改进方案

### 核心改进

**1. 一键应用到所有平台**
- 在用户首次配置自定义 DNS 后，询问是否应用到所有流媒体平台
- 如果选择 Yes，自动为所有平台配置相同的 DNS，跳过后续询问
- 如果选择 No，继续逐个询问

**2. 快速选择已配置的自定义 DNS**
- 如果用户选择 No（不应用到所有平台），在后续选项中添加"7) 使用刚才配置的自定义 DNS"
- 用户可以快速选择已配置的 DNS，无需重新输入

---

## 实现细节

### 修改位置

**文件：** `sb.sh`  
**函数：** `configure_dns_routing_rules`  
**行数：** 2514-2648（修改后）

---

### 新增变量

```bash
apply_custom_to_all=false  # 是否将自定义 DNS 应用到所有平台
```

---

### 改进后的交互流程

#### 场景 1: 应用到所有平台（推荐）

**用户操作：**
```
[1/5] Netflix 使用哪个 DNS 服务器?
请选择 [1-6, 默认: 1]: 6

# 配置自定义 DNS
请输入 DNS 服务器地址: 155.117.18.254
选择 DNS 协议类型: 1 (UDP)
DNS 端口 [默认: 53]: [回车]
DNS 服务器标签名称 [默认: dns_custom_unlock]: media-unlock
确认配置? [Y/n]: Y

# ✅ 新增询问
是否将此自定义 DNS (media-unlock: 155.117.18.254) 应用到所有流媒体平台?
选择 Yes 将自动为 Disney+、Spotify、YouTube、其他流媒体配置相同的 DNS
应用到所有平台? [Y/n]: Y

✓ 已将自定义 DNS 应用到所有流媒体平台

跳过其他平台配置（已使用自定义 DNS: media-unlock）

# 直接进入解析策略配置
选择解析策略:
...
```

**优势：**
- ✅ 只需配置一次自定义 DNS
- ✅ 自动应用到所有平台
- ✅ 节省时间，减少重复操作

---

#### 场景 2: 不应用到所有平台（逐个配置）

**用户操作：**
```
[1/5] Netflix 使用哪个 DNS 服务器?
请选择 [1-6, 默认: 1]: 6

# 配置自定义 DNS
请输入 DNS 服务器地址: 155.117.18.254
...
确认配置? [Y/n]: Y

是否将此自定义 DNS (media-unlock: 155.117.18.254) 应用到所有流媒体平台?
应用到所有平台? [Y/n]: n

将继续逐个配置其他平台

# ✅ 新增选项 7
[2/5] Disney+ 使用哪个 DNS 服务器?
  1) Cloudflare DNS (1.1.1.1)
  2) Google DNS (8.8.8.8)
  3) AdGuard DNS (94.140.14.14)
  4) Quad9 DNS (9.9.9.9)
  5) 本地 DNS
  6) 自定义解锁 DNS (重新配置)
  7) 使用刚才配置的自定义 DNS (media-unlock: 155.117.18.254)

请选择 [1-7, 默认: 7]: 7  # 快速选择已配置的 DNS

[3/5] Spotify 使用哪个 DNS 服务器?
  ...
  7) 使用刚才配置的自定义 DNS (media-unlock: 155.117.18.254)

请选择 [1-7, 默认: 7]: 2  # 或选择其他 DNS
```

**优势：**
- ✅ 灵活配置不同平台使用不同 DNS
- ✅ 快速选择已配置的自定义 DNS（选项 7）
- ✅ 避免重复输入配置信息

---

#### 场景 3: 不使用自定义 DNS（向后兼容）

**用户操作：**
```
[1/5] Netflix 使用哪个 DNS 服务器?
请选择 [1-6, 默认: 1]: 1  # 选择 Cloudflare

[2/5] Disney+ 使用哪个 DNS 服务器?
请选择 [1-6, 默认: 2]: 2  # 选择 Google

# 继续原有流程，无任何变化
```

**优势：**
- ✅ 完全向后兼容
- ✅ 不影响不使用自定义 DNS 的用户

---

## 代码实现

### 1. 初始化变量（第 2521 行）

```bash
apply_custom_to_all=false
```

---

### 2. Netflix 配置后询问（第 2528-2550 行）

```bash
# 如果选择自定义 DNS，配置自定义 DNS 服务器
if [[ $netflix_dns == 6 ]] && [[ $custom_dns_configured == false ]]; then
    configure_custom_dns
    
    # 如果自定义 DNS 配置成功，询问是否应用到所有平台
    if [[ $custom_dns_configured == true ]]; then
        echo -e "\n${YELLOW}是否将此自定义 DNS (${GREEN}$custom_dns_tag: $custom_dns_server${YELLOW}) 应用到所有流媒体平台?${NC}"
        echo -e "${CYAN}选择 Yes 将自动为 Disney+、Spotify、YouTube、其他流媒体配置相同的 DNS${NC}"
        read -p "应用到所有平台? [Y/n]: " apply_to_all
        apply_to_all=${apply_to_all:-Y}
        
        if [[ $apply_to_all =~ ^[Yy]$ ]]; then
            apply_custom_to_all=true
            disney_dns=6
            spotify_dns=6
            youtube_dns=6
            other_dns=6
            echo -e "${GREEN}✓ 已将自定义 DNS 应用到所有流媒体平台${NC}\n"
        else
            echo -e "${CYAN}将继续逐个配置其他平台${NC}\n"
        fi
    fi
fi
```

---

### 3. 条件询问其他平台（第 2552-2648 行）

```bash
# 如果没有应用到所有平台，继续逐个询问
if [[ $apply_custom_to_all == false ]]; then
    # 配置 Disney+
    echo -e "${YELLOW}[2/5] Disney+ 使用哪个 DNS 服务器?${NC}"
    if [[ $custom_dns_configured == true ]]; then
        # 显示扩展选项（包括选项 7）
        echo -e "  ${CYAN}1)${NC} Cloudflare DNS (1.1.1.1)"
        ...
        echo -e "  ${CYAN}7)${NC} 使用刚才配置的自定义 DNS ${GREEN}($custom_dns_tag: $custom_dns_server)${NC}\n"
        read -p "请选择 [1-7, 默认: 7]: " disney_dns
        disney_dns=${disney_dns:-7}
    else
        # 显示标准选项（1-6）
        read -p "请选择 [1-6, 默认: 2]: " disney_dns
        disney_dns=${disney_dns:-2}
    fi
    
    # 处理选项 7（使用已配置的自定义 DNS）
    if [[ $disney_dns == 7 ]]; then
        disney_dns=6  # 映射到自定义 DNS
    fi
    
    # Spotify、YouTube、其他流媒体同样处理
    ...
else
    # 已应用到所有平台，跳过询问
    echo -e "${CYAN}跳过其他平台配置（已使用自定义 DNS: $custom_dns_tag）${NC}\n"
fi
```

---

## 测试场景

### 测试 1: 应用到所有平台 ✅

**步骤：**
1. 选择选项 14（DNS 分流配置）
2. 选择选项 1（配置 DNS 分流规则）
3. Netflix 选择 6（自定义 DNS）
4. 输入 DNS 配置（155.117.18.254, UDP, 53, media-unlock）
5. 询问是否应用到所有平台，选择 Y

**预期结果：**
- ✅ 显示"✓ 已将自定义 DNS 应用到所有流媒体平台"
- ✅ 跳过 Disney+、Spotify、YouTube、其他流媒体的询问
- ✅ 直接进入解析策略配置
- ✅ 所有平台使用相同的自定义 DNS

---

### 测试 2: 不应用到所有平台，使用选项 7 ✅

**步骤：**
1. Netflix 选择 6（自定义 DNS）
2. 输入 DNS 配置
3. 询问是否应用到所有平台，选择 n
4. Disney+ 显示选项 1-7，选择 7（使用刚才配置的 DNS）
5. Spotify 显示选项 1-7，选择 7
6. YouTube 显示选项 1-7，选择 2（Google DNS）
7. 其他流媒体显示选项 1-7，选择 7

**预期结果：**
- ✅ Disney+、Spotify、其他流媒体使用自定义 DNS
- ✅ YouTube 使用 Google DNS
- ✅ 无需重复输入自定义 DNS 配置

---

### 测试 3: 不使用自定义 DNS（向后兼容）✅

**步骤：**
1. Netflix 选择 1（Cloudflare）
2. Disney+ 选择 2（Google）
3. Spotify 选择 3（AdGuard）
4. YouTube 选择 2（Google）
5. 其他流媒体选择 1（Cloudflare）

**预期结果：**
- ✅ 正常配置，无任何变化
- ✅ 不显示选项 7
- ✅ 完全向后兼容

---

### 测试 4: 取消自定义 DNS 配置 ✅

**步骤：**
1. Netflix 选择 6（自定义 DNS）
2. 输入 DNS 配置
3. 确认配置时选择 n（取消）
4. 继续配置 Disney+

**预期结果：**
- ✅ 自定义 DNS 未配置（`custom_dns_configured=false`）
- ✅ 不询问是否应用到所有平台
- ✅ Disney+ 显示标准选项 1-6（不显示选项 7）

---

## 用户体验改进

### 改进前

**配置所有平台使用相同自定义 DNS：**
- 操作次数：5 次选择 + 5 次完整配置 = **10 次操作**
- 时间消耗：约 **5-10 分钟**
- 错误风险：**高**（重复输入容易出错）

---

### 改进后

**场景 1: 应用到所有平台**
- 操作次数：1 次选择 + 1 次配置 + 1 次确认 = **3 次操作**
- 时间消耗：约 **1-2 分钟**
- 错误风险：**低**

**场景 2: 使用选项 7**
- 操作次数：1 次配置 + 4 次选择选项 7 = **5 次操作**
- 时间消耗：约 **2-3 分钟**
- 错误风险：**低**

---

### 改进效果

- ✅ **操作次数减少 50%-70%**
- ✅ **时间消耗减少 60%-80%**
- ✅ **错误风险显著降低**
- ✅ **用户体验大幅提升**

---

## 兼容性

### 向后兼容 ✅

- ✅ 不使用自定义 DNS 的用户：无任何变化
- ✅ 使用预定义 DNS 的用户：无任何变化
- ✅ 现有配置文件：无需修改

### 新功能 ✅

- ✅ 一键应用到所有平台
- ✅ 快速选择已配置的自定义 DNS
- ✅ 清晰的提示信息

---

## 总结

### 核心改进

1. **一键应用** - 自定义 DNS 可一键应用到所有流媒体平台
2. **快速选择** - 新增选项 7，快速选择已配置的自定义 DNS
3. **智能跳过** - 应用到所有平台后，自动跳过后续询问
4. **向后兼容** - 不影响现有用户的使用习惯

### 用户价值

- ✅ **效率提升** - 减少 50%-70% 的操作次数
- ✅ **时间节省** - 减少 60%-80% 的配置时间
- ✅ **降低错误** - 避免重复输入导致的配置错误
- ✅ **体验优化** - 更符合用户预期的交互流程

---

**改进完成！** 🎉

DNS 分流配置现在支持一键应用自定义 DNS 到所有流媒体平台，大幅提升配置效率和用户体验。

